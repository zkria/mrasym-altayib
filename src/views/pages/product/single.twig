{#
| المتغير                                | النوع                       | الوصف                                                                |
|----------------------------------------|-----------------------------|----------------------------------------------------------------------|
| page                                    | object                      |                                                                        |
| page.title                             | string                      | *يمكن أن يحتوي على HTML                                               |
| page.slug                              | string                      | مثال: "cat.show"                                                      |
| product                                | Product                     |                                                                        |
| product.id                             | int                         |                                                                        |
| product.name                           | string                      |                                                                        |
| product.description                    | string                      | HTML                                                                   |
| product.url                            | string                      |                                                                        |
| product.promotion_title                | string                      |                                                                        |
| product.subtitle                       | string                      |                                                                        |
| product.type                           | string                      | منتج، خدمة، مجموعة_منتجات، أكواد، رقمي، طعام، تبرع                    |
| product.status                         | string                      | للبيع، نفذ، نفذ-مع-الإشعار                                            |
| product.weight                         | ?string                     |                                                                        |
| product.calories                       | ?float                      |                                                                        |
| product.sku                            | ?string                      |                                                                        |
| product.rating                         | ?Rating                     |                                                                        |
| product.rating.count                   | int                         |                                                                        |
| product.rating.stars                   | int                         |                                                                        |
| product.price                          | float                       | يمكن أن يكون نصياً أيضاً `-` عندما لا يريد التاجر إظهار الصفر         |
| product.sale_price                     | float                       |                                                                        |
| product.regular_price                  | float                       |                                                                        |
| product.starting_price                 | ?float                      |                                                                        |
| product.quantity                       | ?int                        | إذا كانت القيمة null، فهذا يعني أن الكمية غير محدودة                  |
| product.sold_quantity                  | int                         |                                                                        |
| product.max_quantity                   | int                         |                                                                        |
| product.discount_ends                  | ?date                       |                                                                        |
| product.is_taxable                     | bool                        | هل الضريبة مشمولة في السعر                                            |
| product.category                       | ?Category                   |                                                                        |
| product.category.name                  | string                      |                                                                        |
| product.category.url                   | string                      |                                                                        |
| product.image                          | object                      |                                                                        |
| product.image.url                      | string                      |                                                                        |
| product.image.alt                      | ?string                     |                                                                        |
| product.images                         | array                       |                                                                        |
| product.images[].id                    | int                         |                                                                        |
| product.images[].url                   | string                      |                                                                        |
| product.images[].alt                   | ?string                     |                                                                        |
| product.images[].video_url             | ?string                     |                                                                        |
| product.images[].type                  | string                      | `صورة` `فيديو`                                                        |
| product.brand                          | ?object                     |                                                                        |
| product.brand.id                       | int                         |                                                                        |
| product.brand.url                      | ?string                      |                                                                        |
| product.brand.name                     | ?string                     |                                                                        |
| product.brand.logo                     | ?string                     |                                                                        |
| product.tags                           | ?Tags[] *Collection         |                                                                        |
| product.tags[].name                    | string                      |                                                                        |
| product.tags[].url                     | string                      |                                                                        |
| product.options                        | ProductOption[] *Collection | @انظر views/pages/partials/product/options.twig                        |
| product.notify_availability            | ?object                     | هل المنتج نفذ وهل يمكن للزائر الاشتراك للإشعار بالتوفر                |
| product.notify_availability.channels   | array                       | مثال: ['sms', 'email']                                                |
| product.notify_availability.subscribed | bool                        | هل اشترك المستخدم مسبقاً                                              |
| product.donation                       | ?ProductDonation            |                                                                        |
| product.donation.target_message        | ?string                     | رسالة عند الوصول للهدف أو انتهاء مدة الهدف                            |
| product.donation.collected_amount      | float                       |                                                                        |
| product.donation.target_amount         | float                       |                                                                        |
| product.donation.target_percent        | float                       |                                                                        |
| product.donation.target_end_date       | ?Date                       |                                                                        |
| product.donation.can_donate            | bool                        | `true` عندما لا توجد حملة أو (لم يتم الوصول للهدف ولم تنتهي المدة)    |
| product.has_read_more                  | bool                        |                                                                        |
| product.can_add_note                   | bool                        |                                                                        |
| product.can_show_remained_quantity     | bool                        |                                                                        |
| product.can_show_sold                  | bool                        |                                                                        |
| product.can_upload_file                | bool                        |                                                                        |
| product.has_custom_form                | bool                        | هل هو منتج `طعام` أو `خدمة مخصصة`                                     |
| product.has_metadata                   | bool                        |                                                                        |
| product.has_options                    | bool                        |                                                                        |
| product.is_on_sale                     | bool                        | المنتج له سعر مخفض                                                    |
| product.is_hidden_quantity             | bool                        | الكمية مخفية من قبل التاجر، أو المنتج غير متوفر                       |
| product.is_available                   | bool                        |                                                                        |
| product.is_in_wishlist                 | bool                        |                                                                        |
| product.is_out_of_stock                | bool                        |                                                                        |
| product.is_require_shipping            | bool                        |                                                                        |
| product.base_currency_price            | float                       | سعر المنتج بالعملة الأساسية (ريال سعودي)                              |
| product.discount_percentage            | ?string                     | مثال: "20%"                                                           |
| product.has_3d_image                   | bool                        |                                                                        |
| product.has_size_guide                 | bool                        |                                                                        |
| product.is_giftable                    | bool                        |                                                                        |
| product.add_to_cart_label              | string                      |                                                                        |
| product.currency                       | string                      |                                                                        |
#}

{% extends "layouts.master" %}
{% block content %}
    {# إضافة أزرار التنقل في أعلى الصفحة #}
    <nav class="breadcrumbs w-full py-5">
        <salla-breadcrumb></salla-breadcrumb>
    </nav>
    {# بداية عرض المنتج - يحتوي على قسمين رئيسيين #}
    <div class="flex flex-col items-start md:flex-row" id="product-{{ product.id }}">
            
        {# القسم الأول: عرض الصور #}
        <div class="sidebar md:sticky top-24 w-full md:!w-2/4 rtl:ml-8 ltr:mr-8 pb-8 md:pb-16 overflow-hidden shrink-0">
            {% set has_many_images = product.images|length > 1 %}
            
            {# مكون عرض الصور مع المصغرات #}
            <salla-slider
                    id="details-slider-{{ product.id }}"
                    class="details-slider rounded-md image-slider"
                    type="thumbs"
                    loop="false"
                    auto-height
                    listen-to-thumbnails-option
                    show-thumbs-controls="false">
                
                {# عرض عنوان العرض الترويجي إن وجد #}
                {% if product.promotion_title %}
                    <div class="promotion-title">{{ product.promotion_title }}</div>
                {% endif %}

                {# زر إضافة للمفضلة #}
                <salla-button
                        class="btn--wishlist animated sws"
                        data-id="{{ product.id }}"
                        onclick="salla.wishlist.toggle({{ product.id }})"
                        shape="icon"
                        fill="outline"
                        color="light">
                    <i class="sicon-heart"></i>
                </salla-button>

                {# عرض السعرات الحرارية إن وجدت #}
                {% if product.calories %}
                    <div class="absolute z-[2] top-4 rtl:left-4 ltr:right-4 bg-white shadow-sm flex flex-col justify-center items-center rounded-full w-20 h-20 md:w-24 md:h-24">
                        <span class="text-red-500 text-xl leading-none font-bold">{{ product.calories }}</span>
                        <span class="text-xs text-gray-500">{{ trans('pages.products.calories') }}</span>
                    </div>
                {% endif %}

                {# عرض الصور الرئيسية #}
                <div slot="items">
                    {% for image in product.images %}
                        {# التحقق من وجود صور ثلاثية الأبعاد #}
                        {% if image.three_d_image_url %}
                            <model-viewer style="min-height: 500px;" 
                                class="swiper-slide model-entry w-full h-full"
                                loading="eager" camera-controls
                                touch-action="pan-y" auto-rotate
                                poster="{{ image.url }}"
                                src="{{ image.three_d_image_url }}"
                                shadow-intensity="1" 
                                alt="{{ image.alt }}">
                            </model-viewer>
                        {% else %}
                            {# عرض الصور العادية #}
                            <a data-fslightbox="product_{{ product.id }}"
                               data-img-id="{{ image.id }}"
                               data-slid-index="{{ loop.index-1 }}"
                               {% if image.video_url %} 
                               data-video-src="{{ image.video_url }}"
                               {% endif %}
                               data-caption="{{ image.alt }}"
                               data-infinite="false"
                               data-type="{{ image.video_url ? 'youtube' : 'image' }}"
                               href="{{ image.video_url ? image.video_url : image.url }}"
                               aria-label="{{ product.name }}"
                               class="swiper-slide magnify-wrapper homeslider__slide {{ image.video_url ? 'video-entry' : '' }}">
                                {# تحميل الصورة الأولى مباشرة والباقي بشكل كسول #}
                                {% if loop.first %}
                                    <img id="{{ image.id }}" 
                                         fetchpriority="high" 
                                         loading="eager" 
                                         src="{{ image.url }}"
                                         alt="{{ image.alt }}"
                                         class="h-full object-{{ theme.settings.get('slider_background_size') }} w-full {{ image.three_d_image_url ? 'model-poster' : '' }}">
                                {% else %}
                                    <img id="{{ image.id }}" 
                                         src="{{ 'images/s-empty.png' | cdn }}" 
                                         data-src="{{ image.url }}"
                                         alt="{{ image.alt }}"
                                         class="lazy h-full object-{{ theme.settings.get('slider_background_size') }} w-full {{ image.three_d_image_url ? 'model-poster' : '' }}">
                                {% endif %}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>

                {# عرض المصغرات إذا كان هناك أكثر من صورة #}
                {% if has_many_images %}
                    <div slot="thumbs">
                        {% for image in product.images %}
                            <div class="slide--one-fourth {{ image.video_url ? 'video-entry' : '' }} {{ image.three_d_image_url ? 'model-entry' : '' }}">
                                {% if loop.index < 5 %}
                                    <img src="{{ image.url }}"
                                         loading="eager"
                                         class="object-cover w-full h-full bg-gray-100 rounded-md overflow-hidden"
                                         title="{{ image.alt }}"
                                         alt="{{ image.alt }}"/>
                                {% else %}
                                    <img data-src="{{ image.url }}" 
                                         src="{{ 'images/s-empty.png' | cdn }}"
                                         class="object-cover w-full h-full lazy bg-gray-100 rounded-md overflow-hidden"
                                         title="{{ image.alt }}"
                                         alt="{{ image.alt }}"/>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </salla-slider>
        </div>

        {# القسم الثاني: تفاصيل المنتج #}
        <div class="main-content md:sticky md:overflow-hidden top-24 w-full md:w-2/4 md:pb-16">
            {% hook 'product:single.description.start' %}

            {# عرض العلامة التجارية إن وجدت #}
            {% if product.brand.name %}
                <div class="product-brand mb-5 w-12">
                    <a class="brand-logo" href="{{ product.brand.url }}" title="{{ product.brand.name }}">
                        <img width="100%" height="100%" 
                             class="max-h-full object-contain"
                             src="{{ product.brand.logo }}"
                             title="{{ product.brand.name }}"
                             alt="{{ product.brand.name }}">
                    </a>
                </div>
            {% endif %}

            {# عرض معلومات الضريبة #}
            {% if product.is_taxable %}
                <small class="color-grey">{{ trans('pages.products.tax_included') }}</small>
            {% endif %}

            {# اسم المنتج #}
            <h1 class="text-xl md:text-2xl leading-10 font-bold mb-6 text-gray-800">{{ product.name }}</h1>

            {# العنوان الفرعي للمنتج #}
            {% if product.subtitle %}
                <h2 class="product-entry__sub-title text-sm text-gray-500 leading-6 mb-2.5">
                    {{ product.subtitle }}
                </h2>
            {% endif %}

            {# تقييم المنتج #}
            {% if product.rating %}
                <salla-rating-stars value="{{ product.rating.stars }}"
                                  reviews="{{ product.rating.count }}">
                </salla-rating-stars>
            {% endif %}

            {# عرض الأسعار #}
            <div class="flex whitespace-nowrap gap-4 items-center">
                {# سعر التخفيض والسعر الأصلي #}
                <div class="{{ product.is_on_sale ? '' : 'hidden' }} space-x-2 rtl:space-x-reverse whitespace-nowrap">
                    <h4 class="text-red-800 font-bold text-xl inline-block">{{ product.sale_price | money }}</h4>
                    <span class="text-gray-500 line-through">{{ product.regular_price | money }}</span>
                </div>
                
                {# السعر العادي أو سعر البداية #}
                <div class="gap-4 {{ product.is_on_sale ? 'hidden' : 'flex' }}">
                    {% if product.starting_price %}
                        <span class="">{{ trans('pages.products.starting_price') }}</span>
                    {% endif %}
                    <h2 class="font-bold text-xl inline-block">
                        {{ product.starting_price ? product.starting_price | money : product.price | money }}
                    </h2>
                </div>
            </div>
       {# ... existing code ... #}

        {# التبويبات #}
        <div class="product-tabs-container" x-data="{ 
            activeTab: 'description',
            tabs: {
                description: true,
                reviews: {{ product.rating ? 'true' : 'false' }},
                questions: true
            }
        }">
            <div class="tabs-header">
                <button class="tab-btn" 
                        :class="{ 'active': activeTab === 'questions' }"
                        @click.prevent="activeTab = 'questions'">
                    الأسئلة
                </button>
                
                <button class="tab-btn" 
                        :class="{ 'active': activeTab === 'reviews' }"
                        @click.prevent="activeTab = 'reviews'">
                    التقييمات
                </button>
                
                <button class="tab-btn" 
                        :class="{ 'active': activeTab === 'description' }"
                        @click.prevent="activeTab = 'description'">
                    تفاصيل المنتج
                </button>
            </div>

            <div class="tabs-content">
                {# محتوى تبويب الأسئلة #}
                <div x-cloak x-show.transition.in.opacity.duration.600ms="activeTab === 'questions'" class="tab-panel">
                    <salla-product-questions 
                        product-id="{{ product.id }}">
                    </salla-product-questions>
                </div>

                {# محتوى تبويب التقييمات #}
                <div x-cloak x-show.transition.in.opacity.duration.600ms="activeTab === 'reviews'" class="tab-panel">
                    {% if product.rating %}
                        <div class="reviews-summary">
                            <salla-rating-stars 
                                value="{{ product.rating.stars }}" 
                                readonly>
                            </salla-rating-stars>
                            <span class="rating-count">
                                ({{ product.rating.count }} تقييم)
                            </span>
                        </div>
                        <salla-comments 
                            item-id="{{ product.id }}" 
                            type="product">
                        </salla-comments>
                    {% endif %}
                </div>

                {# محتوى تبويب تفاصيل المنتج #}
                <div x-cloak x-show.transition.in.opacity.duration.600ms="activeTab === 'description'" class="tab-panel">
                    <div class="product-description">
                        {{ product.description|raw }}
                    </div>
                    {% if product.has_metadata %}
                        <div class="product-specifications mt-6">
                            <salla-metadata></salla-metadata>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# المنتجات المقترحة #}
        <div class="suggested-products">
            <h3 class="section-title">منتجات مقترحة</h3>
            
            <div class="products-slider">
                <salla-products-slider 
                    source="related_products"
                    product-card-class="product-entry--minimal"
                    product-id="{{ product.id }}"
                    limit="8">
                </salla-products-slider>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script defer src="{{ 'product.js' | asset }}"></script>
    {% if product.has_3d_image %}
        <script type="module" defer src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    {% endif %}
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabsContainer = document.querySelector('.tabs-header');
            const tabs = tabsContainer.querySelectorAll('.tab-btn');
            const indicator = tabsContainer.querySelector('.tab-indicator');

            function setIndicator(tab) {
                indicator.style.width = tab.offsetWidth + 'px';
                indicator.style.left = tab.offsetLeft + 'px';
            }

            // تفعيل التاب الأول افتراضياً
            setIndicator(tabs[0]);
            tabs[0].classList.add('active');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // إزالة الكلاس النشط من جميع التابات
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // إضافة الكلاس النشط للتاب المحدد
                    tab.classList.add('active');
                    
                    // تحريك المؤشر
                    setIndicator(tab);
                });
            });
        });
    </script>
{% endblock %}
